<html>
<head>
<meta name="viewport" content="width=device-width" />
	<script src="https://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
	<link rel="stylesheet" type="text/css" href="clickfix.css"></link>
	<script type="text/javascript">
		$(document).ready(function () {
			
			$.get("https://townofchapelhill.github.io/scf-reconciliation/metadata.txt", function(data) {
				//To be used when we find another place to put the date
				//$(".title").append("Last Updated: " + moment(data).format('MMMM Do, Y'));
            });
			
			var config;
			$.get("https://townofchapelhill.github.io/scf-reconciliation/config.txt", function(data) {
				config = data.split("\n");
				for(var s in config) config[s] = config[s].trim();
            });
			
			$.getJSON("https://townofchapelhill.github.io/scf-reconciliation/seeclickfix.json",
            function processData(jsonData) {
                var totalRequests = 0;
                var sumTotal = 0;
                
				var firstLoop = true;
				var questions = new Map();
				
				$.each(jsonData.issues, function (object, objectData) {
					
					//console.log(objectData);
					
					if(firstLoop){
						$(".pageTitle").append(objectData.request_type.title);
						$(".title").append(objectData.request_type.title);
						for (var i in config) for(var q in objectData.questions) if(config[i] === objectData.questions[q].question.trim()){ 
							questions.set(config[i], q);
							$(".header").append("<th>" + config[i] + "</th>");
							break;
						}
						firstLoop = false;
					}
					
					var output = "<tr><td>" + objectData.id + "</td>";;
					for(var i of questions.values()) output += "<td>" + getAnswer(objectData.questions, i) + "</td>";
					output += "</tr>";
					$("table").append(output);
					
					totalRequests++;
					if(objectData.questions != null && !isNaN(getAnswer(objectData.questions, questions.get("Amount paid")))) sumTotal += parseInt(getAnswer(objectData.questions, questions.get("Amount paid")));
                
					if(totalRequests === jsonData.issues.length) {
						$(".number").append("The Total Number of Requests is " + totalRequests);
						$(".amount").append("The Amount Paid Sum is " + sumTotal + " dollars");
                    }
                    
                });
			});
			
		});
		
		//Returns the answer to a given question in a list of questions.
		function getAnswer(questions, num){
			if(questions === null) return "No Answer Given (null)";
			if(questions[num] === null) return "No Answer Given (null)";
			return questions[num].answer
		}
		
        function downloadCSV(csv,filename) {
            var csvSCF;
            var downloadLink;
            
            csvSCF = new Blob([csv], {type: 'text/csv' });
            
            downloadLink = document.createElement("a");
            
            
            downloadLink.download = filename;
             //creating a link to the file
             //pasing in the new CSV object
             downloadLink.href = window.URL.createObjectURL(csvSCF);
             downloadLink.style.display = 'none';
             document.body.appendChild(downloadLink);
             downloadLink.click();
               
    }
        function exportTableToCSV(filename) {
        
        var csv = [];
        var rows = document.querySelectorAll("table tr");
        
         for (var i = 0; i < rows.length; i++) {
        //assigning each row of the csv fileto be the td elements from the table
        var row = [], cols = rows[i].querySelectorAll("td, th");
        
        for (var j = 0; j < cols.length; j++) 
            row.push(cols[j].innerText);
        
        csv.push(row.join(","));        
    }
    // Download CSV file
    downloadCSV(csv.join("\n"), filename);
      
    }
	</script>
<title class = "pageTitle"></title>
</head>
</body>
	<h2 class = "title"></h2>
    <div>
	<table class = "table">
		<tr class = "header">
			<th>Request ID#</th>
		</tr>
	</table>
    </div>
     <p class = "number">
    </p>
     <p class = "amount">
     </p>
     <div>
    <button onclick="exportTableToCSV('SCF.csv')"><img src="download_icon.svg" width="25"/> Export SCF Table to CSV File</button>
    </div>
</body>
</html>